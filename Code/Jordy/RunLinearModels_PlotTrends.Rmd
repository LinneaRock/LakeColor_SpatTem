---
title: "Jordy_Data_Analysis"
author: "Jordan Von Eggers"
date: "2023-10-18"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 0. Set up on Beartooth 
Request resources, move to directory, and load modules for R
```{bash}
ssh jvonegge@beartooth.arcc.uwyo.edu
cd /project/lakecolor/data_analysis

salloc --mem=110GB --nodes=1 --cpus-per-task=1 --account=microbiome --time=2:00:00

module load arcc/1.0  gcc/12.2.0 
module load r/4.2.2
R
```

```{r}
require(tidyverse)
#color for manually created legend
bg.fui = tibble(
  ymin = c(470,475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583),
  ymax = c(475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583,590),
  color = c(
  "#2158bc", "#316dc5", "#327cbb", "#4b80a0", "#568f96", "#6d9298", "#698c86", 
  "#759e72", "#7ba654", "#7dae38", "#94b660","#94b660", "#a5bc76", "#aab86d", 
  "#adb55f", "#a8a965", "#ae9f5c", "#b3a053", "#af8a44", "#a46905", "#9f4d04")
)
```



# 1. Histogram of temporal lake size
```{r}
load("2023-10-19_TEMPORAL_Limnosat_May_Oct_Lagos_Filtered.RData")


pdf(paste0(Sys.Date(),"_TEMPORAL_HistogramLakeSize.pdf"), height=8,width=7)
hist(temporal$lake_waterarea_ha, xlim=c(0,1000),breaks=100000)
dev.off()


uniq_lakes <-temporal[,names(temporal)%in%c("lake_nhdid","lake_waterarea_ha")]
uniq_lakes<-unique(uniq_lakes)

uniq_lakes_small<-uniq_lakes[uniq_lakes$lake_waterarea_ha<11,]


pdf(paste0("/gscratch/jvonegge/LakeColor/",Sys.Date(),"_TEMPORAL_HistogramLakeSize_SmallLakes.pdf"), height=8,width=7)
hist(uniq_lakes_small$lake_waterarea_ha,ylab="Freq", xlab="Lake size (hectares)", main="Histogram of temporal dataset lakes < 11 ha")
dev.off()


uniq_lakes_med<-uniq_lakes[uniq_lakes$lake_waterarea_ha<100,]

pdf(paste0("/gscratch/jvonegge/LakeColor/",Sys.Date(),"_TEMPORAL_HistogramLakeSize_LakesLessThan100ha.pdf"), height=8,width=7)
hist(uniq_lakes_med$lake_waterarea_ha, ylab="Freq", xlab="Lake size (hectares)", main="Histogram of temporal dataset lakes < 100 ha")
dev.off()

rm(list=setdiff(ls(), "temporal"))

```

# 2. run linear models for temporal dataset
## a. run on supercomputer
```{r}
require(tidyverse)
load("../../data/2023-10-19_TEMPORAL_Limnosat_May_Oct_Lagos_Filtered.RData")

bg.fui = tibble(
        ymin = c(470,475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583),
        ymax = c(475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583,590),
        color = c(
                "#2158bc", "#316dc5", "#327cbb", "#4b80a0", "#568f96", "#6d9298", "#698c86", 
                "#759e72", "#7ba654", "#7dae38", "#94b660","#94b660", "#a5bc76", "#aab86d", 
                "#adb55f", "#a8a965", "#ae9f5c", "#b3a053", "#af8a44", "#a46905", "#9f4d04")
)

bg.fui<-as.data.frame(bg.fui)

temporal_avg_lms <- temporal %>%
        group_by(lake_nhdid) %>%
        mutate(range_dwl_site=max(dWL)-min(dWL)) %>% 
        ungroup() %>%
        group_by(lake_nhdid,year) %>%
        mutate(avg_dwl_year=mean(dWL), 
               range_dwl_site_year= max(dWL)- min(dWL),
               obs_year=n(),
               obs_days_year=as.numeric(max(as.Date(date)) - min(as.Date(date)))) %>% ungroup() %>%
        group_by(lake_nhdid) %>%
        mutate(mean_range_dwl_site=mean(range_dwl_site_year)) %>% ungroup() %>%
        select(-date,-dWL,-brightness,-normalized_green,-Nir,-lake_year) %>% 
        distinct() %>%
        
        #linear models
        group_by(lake_nhdid) %>%
        mutate(lm_yint=summary(lm(avg_dwl_year~year))$coefficients[1,1],
               lm_pval=summary(lm(avg_dwl_year~year))$coefficients[2,4],
               lm_rsq=summary(lm(avg_dwl_year~year))$r.squared,
               lm_slope=summary(lm(avg_dwl_year~year))$coefficients[2,1],
               residuals=abs(lm(avg_dwl_year~year)$residuals),
               resid_yint=summary(lm(residuals~year))$coefficients[1,1], 
               resid_pval=summary(lm(residuals~year))$coefficients[2,4],
               resid_rsq=summary(lm(residuals~year))$r.squared,
               resid_slope=summary(lm(residuals~year))$coefficients[2,1]) %>% ungroup() %>%
        
        #adding in hex color
        mutate( col_hex = case_when(avg_dwl_year >=bg.fui[1,1] & avg_dwl_year <bg.fui[1,2] ~ bg.fui[1,3],
                                    avg_dwl_year >=bg.fui[2,1] & avg_dwl_year <bg.fui[2,2] ~bg.fui[2,3], 
                                    avg_dwl_year >=bg.fui[3,1] & avg_dwl_year <bg.fui[3,2] ~bg.fui[3,3]   , 
                                    avg_dwl_year >=bg.fui[4,1] & avg_dwl_year <bg.fui[4,2] ~bg.fui[4,3]   , 
                                    avg_dwl_year >=bg.fui[5,1] & avg_dwl_year <bg.fui[5,2] ~bg.fui[5,3]   , 
                                    avg_dwl_year >=bg.fui[6,1] & avg_dwl_year <bg.fui[6,2] ~bg.fui[6,3]   , 
                                    avg_dwl_year >=bg.fui[7,1] & avg_dwl_year <bg.fui[7,2] ~bg.fui[7,3]   , 
                                    avg_dwl_year >=bg.fui[8,1] & avg_dwl_year <bg.fui[8,2] ~bg.fui[8,3]   , 
                                    avg_dwl_year >=bg.fui[9,1] & avg_dwl_year <bg.fui[9,2] ~bg.fui[9,3]   , 
                                    avg_dwl_year >=bg.fui[10,1] & avg_dwl_year <bg.fui[10,2] ~bg.fui[10,3]   , 
                                    avg_dwl_year >=bg.fui[11,1] & avg_dwl_year <bg.fui[11,2] ~bg.fui[11,3]   , 
                                    avg_dwl_year >=bg.fui[12,1] & avg_dwl_year <bg.fui[12,2] ~bg.fui[12,3]   , 
                                    avg_dwl_year >=bg.fui[13,1] & avg_dwl_year <bg.fui[13,2] ~bg.fui[13,3]   , 
                                    avg_dwl_year >=bg.fui[14,1] & avg_dwl_year <bg.fui[14,2] ~bg.fui[14,3]   , 
                                    avg_dwl_year >=bg.fui[15,1] & avg_dwl_year <bg.fui[15,2] ~bg.fui[15,3]   , 
                                    avg_dwl_year >=bg.fui[16,1] & avg_dwl_year <bg.fui[16,2] ~bg.fui[16,3]   , 
                                    avg_dwl_year >=bg.fui[17,1] & avg_dwl_year <bg.fui[17,2] ~bg.fui[17,3]   , 
                                    avg_dwl_year >=bg.fui[18,1] & avg_dwl_year <bg.fui[18,2] ~bg.fui[18,3]   , 
                                    avg_dwl_year >=bg.fui[19,1] & avg_dwl_year <bg.fui[19,2] ~bg.fui[19,3]   , 
                                    avg_dwl_year >=bg.fui[20,1] & avg_dwl_year <bg.fui[20,2] ~bg.fui[20,3]   , 
                                    avg_dwl_year >=bg.fui[21,1] & avg_dwl_year <=bg.fui[21,2] ~bg.fui[21,3] , T~"black")) %>%
        
        #adding in category
        group_by(lake_nhdid) %>%
        mutate(dwl_prior2002=mean(avg_dwl_year[year <= 2002])) %>%
        ungroup() %>%
        
        mutate(trend_cat= case_when(
                lm_pval <= 0.05 & lm_slope >= 0 & dwl_prior2002 < 530 ~ 'Blue -> Greener',
                lm_pval <= 0.05 & lm_slope >= 0 & dwl_prior2002 > 530 ~ 'Intensifying Green/brown',
                lm_pval <= 0.05 & lm_slope <= 0 & dwl_prior2002 > 530 ~ 'Green -> Bluer',
                lm_pval <= 0.05 & lm_slope <= 0 & dwl_prior2002 < 530 ~ 'Intensifying Blue',
                lm_pval > 0.05 & dwl_prior2002 < 530 ~ 'No trend - Blue',
                lm_pval > 0.05 & dwl_prior2002 > 530 ~ 'No trend - Green/brown'
        ),
        trend_cat = factor(
                trend_cat,
                levels = c(
                        'No trend - Blue',
                        'No trend - Green/brown',
                        'Intensifying Blue',
                        'Green -> Bluer',
                        'Intensifying Green/brown',
                        'Blue -> Greener'
                )
        )
        )


write.csv(temporal_avg_lms,paste0(Sys.Date(),"_TEMPORAL_Avg_LMs.csv"))
```

run_2023-11-27_TEMPORAL_Avg_LMs.sh
```{bash}
#!/bin/bash
#SBATCH --job-name temporal_lms
#SBATCH --mem=100GB
#SBATCH --time=4-00:00:00
#SBATCH --cpus-per-task=1
#SBATCH --account=microbiome
#SBATCH --output=temporal_lms_%A.out

cd /project/lakecolor/data_analysis
module load arcc/1.0  gcc/12.2.0 
module load r/4.2.2

srun Rscript 2023-11-05_TEMPORAL_Avg_LMs.R
date
```


## b. figure out "black" points
```{r}
temporal<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/Collaborations/LakeColor/2023-12-05_TEMPORAL_Avg_LMs.csv", header=T,row.names=1)

#black observations
black<- temporal %>% filter(col_hex=="black") %>% select(lake_nhdid,lake_lat_decdeg, lake_lon_decdeg,avg_dwl_year, year, col_hex) %>%distinct()

```


## c. rename ecoregion
```{r}

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_color,trend_cat,epanutr_zoneid) %>%
        distinct()

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6")

temporal_uniq$ecoreg_color <- cols[as.factor(temporal_uniq$epanutr_zoneid )]

states <- map_data("state")
ggplot(data = temporal_uniq, aes(x = lake_lon_decdeg, y = lake_lat_decdeg, color = ecoreg_color)) +
  geom_point(size = 0.7) +
  scale_color_manual(values = unique(temporal_uniq$ecoreg_color), 
                     labels = unique(temporal_uniq$epanutr_zoneid)) + 
        guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  coord_fixed(1.3) +
labs(color = "Ecoregion") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "transparent", color = "black", linewidth = 0.5) +
        theme(legend.position = "right",  # Change the legend position to the right
        legend.box.margin = margin(l = -40))

temporal<-temporal %>% 
        mutate(ecoregion_name = case_when(epanutr_zoneid=="epanutr_1"~"Northern Appalachians",
                                          epanutr_zoneid=="epanutr_2"~"Coastal Plains",
                                          epanutr_zoneid=="epanutr_3"~"Northern Plains",
                                          epanutr_zoneid=="epanutr_4"~"Xeric",
                                          epanutr_zoneid=="epanutr_5"~"Western Mountains",
                                          epanutr_zoneid=="epanutr_6"~"Southern Plains",
                                          epanutr_zoneid=="epanutr_7"~"Southern Appalachians",
                                          epanutr_zoneid=="epanutr_8"~"Upper Midwest",
                                          epanutr_zoneid=="epanutr_9"~"Temperate Plains", T~"black"))


temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_color,trend_cat,epanutr_zoneid, ecoregion_name) %>%
        distinct()
temporal_uniq$ecoreg_color <- cols[as.factor(temporal_uniq$epanutr_zoneid )]


eco<-ggplot(data = temporal_uniq, aes(x = lake_lon_decdeg, y = lake_lat_decdeg, color = ecoreg_color)) +
  geom_point(size = 0.7) +
  scale_color_manual(values = unique(temporal_uniq$ecoreg_color), 
                     labels = unique(temporal_uniq$ecoregion_name)) + 
        guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  coord_fixed(1.3) +
labs(color = "Ecoregion") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "transparent", color = "black", linewidth = 0.5) +
        theme(legend.position = "right",  # Change the legend position to the right
        legend.box.margin = margin(l = -20))


jpeg(paste0("Figures/",Sys.Date(),"_Temporal_EcoRegionsMap.jpg"),height=6,width=9, res=500, units="in")
eco
dev.off()

```



## d. plot trends on map
```{r}
require(ggplot2)
# Get state borders
states <- map_data("state")

cols <- c("#A2CD5A", # Blue -> Greener
  "skyblue2",  # Green -> Bluer
  "blue1", #Intensifying Blue
  "green4", #Intensifying Green/brown
  "#E0EEEE", #No trend - Blue
  "#C1FFC1" #  No trend - Green/brown
)
temporal$trend_color <- cols[as.factor(temporal$trend_cat )]

trends<-temporal %>%
        select(trend_cat,trend_color) %>%
        distinct()
print(trends)

                 trend_cat   trend_color
1   No trend - Green/brown        "green4"
2 Intensifying Green/brown        "green1"
3        Intensifying Blue        "blue1"
4           Green -> Bluer      "skyblue2"
5          No trend - Blue "#E0EEEE"
6          Blue -> Greener        "#C1FFC1"

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_color,trend_cat) %>%
        distinct()


map_trends<-ggplot(data = temporal_uniq, aes(x = lake_lon_decdeg, y = lake_lat_decdeg, color = trend_color)) +
  geom_point(size = 0.7) +
  scale_color_manual(values = unique(temporal_uniq$trend_color), 
                     labels = unique(temporal_uniq$trend_cat)) + 
        guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  coord_fixed(1.3) +
labs(color = "Lake color trend") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "transparent", color = "black", linewidth = 0.5) +
        theme(legend.position = "right",  # Change the legend position to the right
        legend.box.margin = margin(l = -40))



jpeg(paste0("Figures/",Sys.Date(),"_LakeColorTrends_EcoRegionsMap.jpg"),height=6,width=9, res=500, units="in")
map_trends
dev.off()

```

## e. plot proportion by ecoregion
```{r}
temporal<-temporal %>% 
        mutate(ecoregion_name = case_when(epanutr_zoneid=="epanutr_1"~"Northern Appalachians",
                                          epanutr_zoneid=="epanutr_2"~"Coastal Plains",
                                          epanutr_zoneid=="epanutr_3"~"Northern Plains",
                                          epanutr_zoneid=="epanutr_4"~"Xeric",
                                          epanutr_zoneid=="epanutr_5"~"Western Mountains",
                                          epanutr_zoneid=="epanutr_6"~"Southern Plains",
                                          epanutr_zoneid=="epanutr_7"~"Southern Appalachians",
                                          epanutr_zoneid=="epanutr_8"~"Upper Midwest",
                                          epanutr_zoneid=="epanutr_9"~"Temperate Plains", T~"black"))


temporal_ecoreg <- temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_cat,trend_color,ecoregion_name) %>%
        group_by(ecoregion_name) %>%
        count(trend_cat)%>% 
  mutate(proportion = n / sum(n))


cols <- c("#A2CD5A", # Blue -> Greener
  "skyblue2",  # Green -> Bluer
  "blue1", #Intensifying Blue
  "green4", #Intensifying Green/brown
  "#E0EEEE", #No trend - Blue
  "#C1FFC1" #  No trend - Green/brown
)
temporal_ecoreg$trend_color <- cols[as.factor(temporal_ecoreg$trend_cat )]
temporal_ecoreg$ecoregion_name <- factor(temporal_ecoreg$ecoregion_name, levels = rev(unique(temporal_ecoreg$ecoregion_name)))

gplt<-ggplot(data = temporal_ecoreg,
       aes(
               x = ecoregion_name,
               y = proportion,
               group = trend_cat,
               col = trend_color
       )) + 
        scale_color_manual(values = c(unique(temporal_ecoreg$trend_color)), labels =c(unique(temporal_ecoreg$trend_cat))) + 
        geom_line(linewidth = 2) + 
        geom_point(size = 3) + 
        theme_bw() + 
        labs(color = "Lake color trend") + 
        xlab(label = "Ecoregion") + 
        ylab(label = "Proportion") +
        theme(axis.text.x = element_text(angle = 45, hjust=1))

jpeg(paste0("Figures/",Sys.Date(),"_LakeColorTrend_ByEcoregion.jpg"),height=4,width=9, res=500, units="in")
gplt
dev.off()


```

















# Figuring out why no TX and GA

```{r}
require(tidyverse)
require(ggplot2)
lake_data<-readRDS("2023-09-29_lagos_landcover_data.rds") #this is the lake data and landcover - need to remove land cover 

# merge with Lagos data (should be static for each lake)
# first take out the landcover data that was attached
lagos<-lake_data[,1:15]
lagos<-distinct(lagos)
nrow(lagos)
#479950

write.csv(lagos,"LAGOSONLYDATA_TEST.csv")


lagos<-read.csv("../LAGOSONLYDATA_TEST.csv")


require(ggplot2)

# Get state borders
states <- map_data("state")

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6"
)

lagos$ecoregion_color <- cols[as.factor(lagos$epanutr_zoneid )]

wmap<-ggplot(data = lagos) + 
        geom_point(data = lagos, aes(x = lake_lon_decdeg, y = lake_lat_decdeg), color = lagos$ecoregion_color, size = 1) +  # Add points
        scale_fill_distiller( palette="Spectral", direction=1)+
        theme_void()+
       coord_fixed(1.3) +
        geom_polygon(data= states, aes(x = long, y = lat, group = group), fill="transparent",color = "black", size=0.5)
wmap





require(tidyverse)
require(ggplot2)
load("2023-10-19_SPATIAL_Limnosat_May_Oct_Lagos_Landcover.RData")

spatial<-spatial[,names(spatial)%in% c("epanutr_zoneid","lake_lon_decdeg","lake_lat_decdeg")]
spatial<-distinct(spatial)

# Get state borders
states <- map_data("state")

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
   "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "black","deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6"
)

spatial$ecoregion_color <- cols[as.factor(spatial$epanutr_zoneid )]

wmap<-ggplot(data = spatial) + 
        geom_point(data = spatial, aes(x = lake_lon_decdeg, y = lake_lat_decdeg), color = spatial$ecoregion_color, size = 1) +  # Add points
        scale_fill_distiller( palette="Spectral", direction=1)+
        theme_void()+
       coord_fixed(1.3) +
        geom_polygon(data= states, aes(x = long, y = lat, group = group), fill="transparent",color = "black", size=0.5)

pdf(paste0(Sys.Date(),"_SPAITAL_sitesByEcoregion.pdf"),height=4, width=6)
           wmap
           dev.off()
           

           
           
           
#look at the initial dataframe used to make             
load("archive/2023-10-18_Limnosat_May_Oct_Lagos.RData")
objects()
spatial<-limnosat_may_oct_lagos
spatial<-spatial[,names(spatial)%in% c("epanutr_zoneid","lake_lon_decdeg","lake_lat_decdeg")]
spatial<-distinct(spatial)

# Get state borders
states <- map_data("state")

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
   "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "black","deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6"
)

spatial$ecoregion_color <- cols[as.factor(spatial$epanutr_zoneid )]

wmap<-ggplot(data = spatial) + 
        geom_point(data = spatial, aes(x = lake_lon_decdeg, y = lake_lat_decdeg), color = spatial$ecoregion_color, size = 1) +  # Add points
        scale_fill_distiller( palette="Spectral", direction=1)+
        theme_void()+
       coord_fixed(1.3) +
        geom_polygon(data= states, aes(x = long, y = lat, group = group), fill="transparent",color = "black", size=0.5)

pdf(paste0(Sys.Date(),"_Limnosat_May_Oct_Lagos_sitesByEcoregion.pdf"),height=4, width=6)
           wmap
           dev.off()
```



checking if GA has permanent column values (ndhids)
```{r}
all_GA <- c("GA_16038.csv", "GA_16039.csv", "GA_17037.csv" ,"GA_17038.csv", "GA_17039.csv" ,"GA_18036.csv" ,"GA_18037.csv", "GA_18038.csv" ,"GA_18039.csv","GA_19036.csv", "GA_19037.csv" ,"GA_19038.csv", "GA_19039.csv" ,"GA_20036.csv", "GA_20037.csv")

uniq_GA<-vector()
i=1
for(i in 1:length(all_GA)){
GA<-read.csv(all_GA[1], header=T)
uniq_GA<-c(uniq_GA,unique(GA$permanent))
}
uniq_GA
 #[1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
```






Question - what types of lakes were removed with the temporal dataset?

