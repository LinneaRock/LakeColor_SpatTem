---
title: "Jordy_Data_Analysis"
author: "Jordan Von Eggers"
date: "2023-10-18"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# 0. Set up on Beartooth 
Request resources, move to directory, and load modules for R
```{bash}
ssh jvonegge@beartooth.arcc.uwyo.edu
cd /project/lakecolor/data

salloc --mem=110GB --nodes=1 --cpus-per-task=1 --account=microbiome --time=2:00:00

module load arcc/1.0  gcc/12.2.0 
module load r/4.2.2
R
```

```{r}
require(tidyverse)
#color for manually created legend
bg.fui = tibble(
  ymin = c(470,475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583),
  ymax = c(475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583,590),
  color = c(
  "#2158bc", "#316dc5", "#327cbb", "#4b80a0", "#568f96", "#6d9298", "#698c86", 
  "#759e72", "#7ba654", "#7dae38", "#94b660","#94b660", "#a5bc76", "#aab86d", 
  "#adb55f", "#a8a965", "#ae9f5c", "#b3a053", "#af8a44", "#a46905", "#9f4d04")
)
```



# 1. Histogram of temporal lake size
```{r}
load("2023-10-19_TEMPORAL_Limnosat_May_Oct_Lagos_Filtered.RData")


pdf(paste0(Sys.Date(),"_TEMPORAL_HistogramLakeSize.pdf"), height=8,width=7)
hist(temporal$lake_waterarea_ha, xlim=c(0,1000),breaks=100000)
dev.off()


uniq_lakes <-temporal[,names(temporal)%in%c("lake_nhdid","lake_waterarea_ha")]
uniq_lakes<-unique(uniq_lakes)

uniq_lakes_small<-uniq_lakes[uniq_lakes$lake_waterarea_ha<11,]


pdf(paste0("/gscratch/jvonegge/LakeColor/",Sys.Date(),"_TEMPORAL_HistogramLakeSize_SmallLakes.pdf"), height=8,width=7)
hist(uniq_lakes_small$lake_waterarea_ha,ylab="Freq", xlab="Lake size (hectares)", main="Histogram of temporal dataset lakes < 11 ha")
dev.off()


uniq_lakes_med<-uniq_lakes[uniq_lakes$lake_waterarea_ha<100,]

pdf(paste0("/gscratch/jvonegge/LakeColor/",Sys.Date(),"_TEMPORAL_HistogramLakeSize_LakesLessThan100ha.pdf"), height=8,width=7)
hist(uniq_lakes_med$lake_waterarea_ha, ylab="Freq", xlab="Lake size (hectares)", main="Histogram of temporal dataset lakes < 100 ha")
dev.off()

rm(list=setdiff(ls(), "temporal"))

```

# 2. run linear models for temporal dataset
## a. run on supercomputer
```{r}
require(tidyverse)
load("../../data/2023-10-19_TEMPORAL_Limnosat_May_Oct_Lagos_Filtered.RData")

bg.fui = tibble(
        ymin = c(470,475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583),
        ymax = c(475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583,590),
        color = c(
                "#2158bc", "#316dc5", "#327cbb", "#4b80a0", "#568f96", "#6d9298", "#698c86", 
                "#759e72", "#7ba654", "#7dae38", "#94b660","#94b660", "#a5bc76", "#aab86d", 
                "#adb55f", "#a8a965", "#ae9f5c", "#b3a053", "#af8a44", "#a46905", "#9f4d04")
)

bg.fui<-as.data.frame(bg.fui)

temporal_avg_lms <- temporal %>%
        group_by(lake_nhdid) %>%
        mutate(range_dwl_site=max(dWL)-min(dWL)) %>% 
        ungroup() %>%
        group_by(lake_nhdid,year) %>%
        mutate(avg_dwl_year=mean(dWL), 
               range_dwl_site_year= max(dWL)- min(dWL),
               obs_year=n(),
               obs_days_year=as.numeric(max(as.Date(date)) - min(as.Date(date)))) %>% ungroup() %>%
        group_by(lake_nhdid) %>%
        mutate(mean_range_dwl_site=mean(range_dwl_site_year)) %>% ungroup() %>%
        select(-date,-dWL,-brightness,-normalized_green,-Nir,-lake_year) %>% 
        distinct() %>%
        
        #linear models
        group_by(lake_nhdid) %>%
        mutate(lm_yint=summary(lm(avg_dwl_year~year))$coefficients[1,1],
               lm_pval=summary(lm(avg_dwl_year~year))$coefficients[2,4],
               lm_rsq=summary(lm(avg_dwl_year~year))$r.squared,
               lm_slope=summary(lm(avg_dwl_year~year))$coefficients[2,1],
               residuals=abs(lm(avg_dwl_year~year)$residuals),
               resid_yint=summary(lm(residuals~year))$coefficients[1,1], 
               resid_pval=summary(lm(residuals~year))$coefficients[2,4],
               resid_rsq=summary(lm(residuals~year))$r.squared,
               resid_slope=summary(lm(residuals~year))$coefficients[2,1]) %>% ungroup() %>%
        
        #adding in hex color
        mutate( col_hex = case_when(avg_dwl_year >=bg.fui[1,1] & avg_dwl_year <bg.fui[1,2] ~ bg.fui[1,3],
                                    avg_dwl_year >=bg.fui[2,1] & avg_dwl_year <bg.fui[2,2] ~bg.fui[2,3], 
                                    avg_dwl_year >=bg.fui[3,1] & avg_dwl_year <bg.fui[3,2] ~bg.fui[3,3]   , 
                                    avg_dwl_year >=bg.fui[4,1] & avg_dwl_year <bg.fui[4,2] ~bg.fui[4,3]   , 
                                    avg_dwl_year >=bg.fui[5,1] & avg_dwl_year <bg.fui[5,2] ~bg.fui[5,3]   , 
                                    avg_dwl_year >=bg.fui[6,1] & avg_dwl_year <bg.fui[6,2] ~bg.fui[6,3]   , 
                                    avg_dwl_year >=bg.fui[7,1] & avg_dwl_year <bg.fui[7,2] ~bg.fui[7,3]   , 
                                    avg_dwl_year >=bg.fui[8,1] & avg_dwl_year <bg.fui[8,2] ~bg.fui[8,3]   , 
                                    avg_dwl_year >=bg.fui[9,1] & avg_dwl_year <bg.fui[9,2] ~bg.fui[9,3]   , 
                                    avg_dwl_year >=bg.fui[10,1] & avg_dwl_year <bg.fui[10,2] ~bg.fui[10,3]   , 
                                    avg_dwl_year >=bg.fui[11,1] & avg_dwl_year <bg.fui[11,2] ~bg.fui[11,3]   , 
                                    avg_dwl_year >=bg.fui[12,1] & avg_dwl_year <bg.fui[12,2] ~bg.fui[12,3]   , 
                                    avg_dwl_year >=bg.fui[13,1] & avg_dwl_year <bg.fui[13,2] ~bg.fui[13,3]   , 
                                    avg_dwl_year >=bg.fui[14,1] & avg_dwl_year <bg.fui[14,2] ~bg.fui[14,3]   , 
                                    avg_dwl_year >=bg.fui[15,1] & avg_dwl_year <bg.fui[15,2] ~bg.fui[15,3]   , 
                                    avg_dwl_year >=bg.fui[16,1] & avg_dwl_year <bg.fui[16,2] ~bg.fui[16,3]   , 
                                    avg_dwl_year >=bg.fui[17,1] & avg_dwl_year <bg.fui[17,2] ~bg.fui[17,3]   , 
                                    avg_dwl_year >=bg.fui[18,1] & avg_dwl_year <bg.fui[18,2] ~bg.fui[18,3]   , 
                                    avg_dwl_year >=bg.fui[19,1] & avg_dwl_year <bg.fui[19,2] ~bg.fui[19,3]   , 
                                    avg_dwl_year >=bg.fui[20,1] & avg_dwl_year <bg.fui[20,2] ~bg.fui[20,3]   , 
                                    avg_dwl_year >=bg.fui[21,1] & avg_dwl_year <=bg.fui[21,2] ~bg.fui[21,3] , T~"black")) %>%
        
        #adding in category
        group_by(lake_nhdid) %>%
        mutate(dwl_prior2002=mean(avg_dwl_year[year <= 2002])) %>%
        ungroup() %>%
        
        mutate(trend_cat= case_when(
                lm_pval <= 0.05 & lm_slope >= 0 & dwl_prior2002 < 530 ~ 'Blue -> Greener',
                lm_pval <= 0.05 & lm_slope >= 0 & dwl_prior2002 > 530 ~ 'Intensifying Green/brown',
                lm_pval <= 0.05 & lm_slope <= 0 & dwl_prior2002 > 530 ~ 'Green -> Bluer',
                lm_pval <= 0.05 & lm_slope <= 0 & dwl_prior2002 < 530 ~ 'Intensifying Blue',
                lm_pval > 0.05 & dwl_prior2002 < 530 ~ 'No trend - Blue',
                lm_pval > 0.05 & dwl_prior2002 > 530 ~ 'No trend - Green/brown'
        ),
        trend_cat = factor(
                trend_cat,
                levels = c(
                        'No trend - Blue',
                        'No trend - Green/brown',
                        'Intensifying Blue',
                        'Green -> Bluer',
                        'Intensifying Green/brown',
                        'Blue -> Greener'
                )
        )
        )


write.csv(temporal_avg_lms,paste0(Sys.Date(),"_TEMPORAL_Avg_LMs.csv"))
```



run_2023-11-27_TEMPORAL_Avg_LMs.sh
```{bash}
#!/bin/bash
#SBATCH --job-name temporal_lms
#SBATCH --mem=100GB
#SBATCH --time=4-00:00:00
#SBATCH --cpus-per-task=1
#SBATCH --account=microbiome
#SBATCH --output=temporal_lms_%A.out

cd /project/lakecolor/data_analysis
module load arcc/1.0  gcc/12.2.0 
module load r/4.2.2

srun Rscript 2023-11-05_TEMPORAL_Avg_LMs.R
date
```

## 2a. Removing lakes that have dominant wavelengths outside of 470-590 for >5 observations. 28 lakes were removed from the analyses.
```{r}
temporal<-read.csv("2023-12-05_TEMPORAL_Avg_LMs.csv", header=T,row.names=1)

dWL_subset  <- temporal |>
  filter(avg_dwl_year > 590 | 
           avg_dwl_year < 470) |>
  group_by(lagoslakeid) |>
  count() |>
  filter(n > 5) # 28 lakes

delete_lakes <- dWL_subset$lagoslakeid

temporal <- temporal |>
  filter(!lagoslakeid %in% delete_lakes)

```



## b. figure out "black" points
```{r}
temporal<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/Collaborations/LakeColor/2023-12-05_TEMPORAL_Avg_LMs.csv", header=T,row.names=1)

#black observations
black <- temporal %>% filter(col_hex=="black") %>% select(lake_nhdid,lake_lat_decdeg, lake_lon_decdeg,avg_dwl_year, year, col_hex) %>% distinct() %>% filter(avg_dwl_year > 590) %>% count(lake_ndhid)

```


## c. rename ecoregion
```{r}
temporal<-read.csv("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/Collaborations/LakeColor/2023-12-05_TEMPORAL_Avg_LMs.csv", header=T,row.names=1)

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_color,trend_cat,epanutr_zoneid) %>%
        distinct()

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6")

temporal_uniq$ecoreg_color <- cols[as.factor(temporal_uniq$epanutr_zoneid )]

legend<-temporal_uniq %>%
        select(epanutr_zoneid ,ecoreg_color) %>%
        distinct() %>% arrange(epanutr_zoneid)

print(legend)

  epanutr_zoneid ecoreg_color
1      epanutr_1  "dodgerblue2"
2      epanutr_2      "#E31A1C"
3      epanutr_3       "green4"
4      epanutr_4      "#6A3D9A"
5      epanutr_5      "#FF7F00"
6      epanutr_6        "black"
7      epanutr_7        "gold1"
8      epanutr_8     "skyblue2"
9      epanutr_9      "#FB9A99"

par(mar=c(3,3,3,7), xpd=T)
plot(temporal_uniq$lake_lon_decdeg, temporal_uniq$lake_lat_decdeg, col= temporal_uniq$ecoreg_color, pch=16, cex=0.5, bty="n")
legend("right",legend=legend$epanutr_zoneid,col=legend$ecoreg_color, pch=16, pt.cex=3, inset = c(-0.2, 0.1))

temporal<-temporal %>% 
        mutate(ecoregion_name = case_when(epanutr_zoneid=="epanutr_1"~"Coastal Plains",
                                          epanutr_zoneid=="epanutr_2"~"Northern Appalachians",
                                          epanutr_zoneid=="epanutr_3"~"Northern Plains",
                                          epanutr_zoneid=="epanutr_4"~"Southern Appalachians",
                                          epanutr_zoneid=="epanutr_5"~"Southern Plains",
                                          epanutr_zoneid=="epanutr_6"~"Temperate Plains",
                                          epanutr_zoneid=="epanutr_7"~"Upper Midwest",
                                          epanutr_zoneid=="epanutr_8"~"Western Mountains",
                                          epanutr_zoneid=="epanutr_9"~"Xeric", T~"black"))
```

plot ecoregions
```{r}

cols <- rev(c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99"))

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_color,trend_cat,epanutr_zoneid, ecoregion_name) %>%
        distinct()
temporal_uniq$ecoregion_name <- factor(temporal_uniq$ecoregion_name, levels=c("Xeric", "Western Mountains","Upper Midwest","Temperate Plains","Southern Plains","Southern Appalachians", "Northern Plains","Northern Appalachians" ,"Coastal Plains"))

temporal_uniq$ecoregion_color <- cols[temporal_uniq$ecoregion_name]

temporal_uniq$ecoregion_color <- factor(temporal_uniq$ecoregion_color, levels=cols)

temporal_uniq %>%
        select(ecoregion_color,ecoregion_name) %>%
        distinct() %>% arrange(ecoregion_name,levels(temporal_uniq$ecoregion_name)) %>% print()

  ecoregion_color        ecoregion_name
1         "#FB9A99"                 Xeric
2        "skyblue2"     Western Mountains
3           "gold1"         Upper Midwest
4           "black"      Temperate Plains
5         "#FF7F00"       Southern Plains
6         "#6A3D9A" Southern Appalachians
7         "green4"       Northern Plains
8         "#E31A1C" Northern Appalachians
9     "dodgerblue2"        Coastal Plains


eco<-ggplot(data = temporal_uniq, aes(x = lake_lon_decdeg, y = lake_lat_decdeg, color=ecoregion_color)) +
  geom_point(size = 0.7) +
  scale_color_manual(values = levels(temporal_uniq$ecoregion_color), 
                     labels = levels(temporal_uniq$ecoregion_name)) + 
        guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  coord_fixed(1.3) +
labs(color = "Ecoregion") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "transparent", color = "black", linewidth = 0.5) +
        theme(legend.position = "right",  # Change the legend position to the right
        legend.box.margin = margin(l = -20))




jpeg(paste0("Figures/",Sys.Date(),"_Temporal_EcoRegionsMap.jpg"),height=6,width=9, res=500, units="in")
eco
dev.off()
```

## d. plot trends on map
in ggplot
```{r}
require(ggplot2)
# Get state borders
states <- map_data("state")

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_cat) %>%
        distinct()
temporal_uniq$trend_cat <- factor(temporal_uniq$trend_cat, levels=c("Intensifying Blue","No trend - Blue","Green -> Bluer", "Blue -> Greener","No trend - Green/brown","Intensifying Green/brown"))


cols <- c("blue1", #Intensifying Blue,
            "#E0EEEE", #No trend - Blue
            "skyblue2",  # Green -> Bluer
          "#A2CD5A", # Blue -> Greener
    "#C1FFC1", #  No trend - Green/brown
  "green4") #Intensifying Green/brown

temporal_uniq$trend_color <- cols[temporal_uniq$trend_cat]

temporal_uniq$trend_color <- factor(temporal_uniq$trend_color, levels=cols)

trends<-temporal_uniq %>%
        select(trend_cat,trend_color) %>%
        distinct() %>% arrange(trend_cat,levels(temporal_uniq$trend_cat))

print(trends)

                 trend_cat trend_color
1        Intensifying Blue      "blue1"
2          No trend - Blue     "#E0EEEE"
3           Green -> Bluer    "skyblue2"
4          Blue -> Greener     "#A2CD5A"
5   No trend - Green/brown     "#C1FFC1"
6 Intensifying Green/brown      "green4"


map_trends<-ggplot(data = temporal_uniq, aes(x = lake_lon_decdeg, y = lake_lat_decdeg, color=trend_color)) +
  geom_point(size = 0.7) +
  scale_color_manual(values = levels(temporal_uniq$trend_color), 
                     labels = levels(temporal_uniq$trend_cat)) + 
        guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  coord_fixed(1.3) +
labs(color = "Lake color trend") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "transparent", color = "black", linewidth = 0.5) +
        theme(legend.position = "right",  # Change the legend position to the right
        legend.box.margin = margin(l = -20))


jpeg(paste0("Figures/",Sys.Date(),"_LakeColorTrends_EcoRegionsMap.jpg"),height=6,width=9, res=500, units="in")
map_trends
dev.off()
```
check in base R
```{r}
cols <- c("#A2CD5A", # Blue -> Greener
  "skyblue2",  # Green -> Bluer
  "blue1", #Intensifying Blue
  "green4", #Intensifying Green/brown
  "#E0EEEE", #No trend - Blue
  "#C1FFC1" #  No trend - Green/brown
)
temporal$trend_color <- cols[as.factor(temporal$trend_cat)]

trends<-temporal %>%
        select(trend_cat,trend_color) %>%
        distinct()
print(trends)

#                  trend_cat trend_color
# 1   No trend - Green/brown     "#C1FFC1"
# 2 Intensifying Green/brown      "green4"
# 3        Intensifying Blue      "blue1"
# 4           Green -> Bluer   "skyblue2"
# 5          No trend - Blue     "#E0EEEE"
# 6          Blue -> Greener     "#A2CD5A"

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, trend_color,trend_cat) %>%
        distinct()

plot(temporal_uniq$lake_lon_decdeg, temporal_uniq$lake_lat_decdeg, col= temporal_uniq$trend_color, pch=16, cex=0.5)
```




## e. plot proportion by ecoregion
```{r}
temporal<-temporal %>% 
        mutate(ecoregion_name = case_when(epanutr_zoneid=="epanutr_1"~"Coastal Plains",
                                          epanutr_zoneid=="epanutr_2"~"Northern Appalachians",
                                          epanutr_zoneid=="epanutr_3"~"Northern Plains",
                                          epanutr_zoneid=="epanutr_4"~"Southern Appalachians",
                                          epanutr_zoneid=="epanutr_5"~"Southern Plains",
                                          epanutr_zoneid=="epanutr_6"~"Temperate Plains",
                                          epanutr_zoneid=="epanutr_7"~"Upper Midwest",
                                          epanutr_zoneid=="epanutr_8"~"Western Mountains",
                                          epanutr_zoneid=="epanutr_9"~"Xeric", T~"black"))


temporal_ecoreg <- temporal %>%
        select(lake_nhdid, trend_cat,trend_color,ecoregion_name) %>%
        group_by(ecoregion_name) %>%
        count(trend_cat)%>% 
  mutate(proportion = n / sum(n))


temporal_ecoreg$trend_cat <- factor(temporal_ecoreg$trend_cat, levels=c("Intensifying Blue","No trend - Blue","Green -> Bluer", "Blue -> Greener","No trend - Green/brown","Intensifying Green/brown"))


cols <- c("blue1", #Intensifying Blue,
            "#E0EEEE", #No trend - Blue
            "skyblue2",  # Green -> Bluer
          "#A2CD5A", # Blue -> Greener
    "#C1FFC1", #  No trend - Green/brown
  "green4") #Intensifying Green/brown

temporal_ecoreg$trend_color <- cols[temporal_ecoreg$trend_cat]

temporal_ecoreg$trend_color <- factor(temporal_ecoreg$trend_color, levels=cols)

temporal_ecoreg[,names(temporal_ecoreg)%in%c("trend_cat","trend_color")] %>%
        distinct() %>% arrange(trend_cat,levels(temporal_ecoreg$trend_cat))


  trend_cat                trend_color
  <fct>                    <fct>      
1 Intensifying Blue        "blue1"      
2 No trend - Blue          "#E0EEEE"    
3 Green -> Bluer           "skyblue2"   
4 Blue -> Greener          "#A2CD5A"    
5 No trend - Green/brown   "#C1FFC1"    
6 Intensifying Green/brown "green4" 



temporal_ecoreg$ecoregion_name <- factor(temporal_ecoreg$ecoregion_name, levels=c("Xeric", "Western Mountains","Upper Midwest","Temperate Plains","Southern Plains","Southern Appalachians", "Northern Plains","Northern Appalachians" ,"Coastal Plains"))

gplt<-ggplot(data = temporal_ecoreg,
       aes(
               x = ecoregion_name,
               y = proportion,
               group = trend_cat,
               col = trend_color
       )) + 
        scale_color_manual(values = levels(temporal_ecoreg$trend_color), 
                           labels = levels(temporal_ecoreg$trend_cat)) + 
        geom_line(linewidth = 2) + 
        geom_point(size = 3) + 
        theme_bw() + 
        labs(color = "Lake color trend") + 
        xlab(label = "Ecoregion") + 
        ylab(label = "Proportion") +
        theme(axis.text.x = element_text(angle = 45, hjust=1))

jpeg(paste0("Figures/",Sys.Date(),"_LakeColorTrend_ByEcoregion.jpg"),height=4,width=9, res=500, units="in")
gplt
dev.off()


```



# 3. Figure 1 Map

```{r}


```

# 3. Figure 1 PCA
Did this in the super computer because was running SO slow on my computer

Read in climate data, average, and merge with the trend dataset, and then with the landcover dataset

Request resources, move to directory, and load modules for R
```{bash}
ssh jvonegge@beartooth.arcc.uwyo.edu
cd /project/lakecolor/data

salloc --mem=110GB --nodes=1 --cpus-per-task=1 --account=microbiome --time=2:00:00

module load arcc/1.0  gcc/12.2.0 
module load r/4.2.2
R
```

```{r}
require(tidyverse)

# read in climate data from PRISM
prism<-readRDS("prism_lakepoint_data.rds")
range(prism$year) # range of PRSIM data
#[1] "1984" "2022"

# average the mean temperature, the temperature range, rainfall, fo the 39 years of observation
prism_avg <- prism %>%
        group_by(lake_nhdid) %>%
        mutate(
                avg_temp_degC = mean(tmean),
                range_temp_degC = mean(tmax - tmin), # this is tmax and min within a year
                avg_ppt = mean(ppt),
                obs_year_prism = n()) %>%
        ungroup() %>%
        select(lake_nhdid,avg_temp_degC,range_temp_degC, avg_ppt,obs_year_prism) %>%
        distinct()
dim(prism_avg) # 145083 sites
table(prism_avg$obs_year_prism) # all have 39 years
summary(prism_avg) # 2 NAs..

# read in temporal trend data
trends<-read.csv("../data_analysis/TEMPORAL_Avg_LMs/2023-12-11_TEMPORAL_Avg_LMs.csv", header=T, row.names=1)

trends$X<-NULL

trends_avg <- trends %>%
        group_by(lake_nhdid) %>%
        mutate(avg_obs_site = mean(obs_year),
               avg_obs_days_site = mean(obs_days_year),
               avg_dwl_site = mean(avg_dwl_year),
               avg_range_dwl_site = mean(range_dwl_site_year)) %>%
                       ungroup()%>%
                       select(-(c(2,3,18:21,27,32))) %>%
        distinct()
dim(trends_avg)

# join the trend data and prism data
trends_prism <- inner_join(trends_avg,prism_avg, by= join_by(lake_nhdid))
dim(trends_prism)

# read in landcover data, filter by lakes we have in trends, and average all columns
landcover <- readRDS("/project/lakecolor/data/archive/2023-09-29_lagos_landcover_data.rds")

landcover_avg <- landcover %>%
        filter(lake_nhdid %in% trends$lake_nhdid) %>%
        select(2, 16, 17:33) %>%
        group_by(lake_nhdid) %>%
        mutate(
                landcover_first_year = min(year),
                landcover_last_year = max(year),
                obs_year_landcover = n(),
                across(starts_with("nlcd"), list(avg = ~ mean(.)), .names = "avg_{.col}")
        ) %>%
        ungroup() %>%
        select(1,20:38) %>% # get rid of year and data from individual years
        distinct() 


landcovered_avg_sum <- landcover_avg %>%
        slice(1:5) %>%
        rowwise() %>%
        mutate(avg_nlcd_dev_pct = sum(
                c(
                        nlcd_devlow22_pct,
                        nlcd_devhi24_pct,
                        nlcd_devmed23_pct,
                        nlcd_devopen21_pct
                ))) %>%
        mutate(avg_nlcd_dev_pct = sum(
                c(
                        nlcd_devlow22_pct,
                        nlcd_devhi24_pct,
                        nlcd_devmed23_pct,
                        nlcd_devopen21_pct
                )))

  mutate(avg_nlcd_dev_pct = sum(across(contains("avg_nlcd_dev"), na.rm = TRUE), na.rm = TRUE))




trends_prism_landcover <- inner_join(trends_prism,landcover_avg, by= join_by(lake_nhdid))
dim(trends_prism_landcover)
```

```{r}
cormat<-cor(landcover[18:33])

require(ggcorrplot)
pdf("Landcover_correlation.pdf",height=10,width=10)
ggcorrplot(cormat)
dev.off()


cormat<-cor(as.matrix(trends_avg[,4:14]))
pdf("Landcover_correlation.pdf",height=10,width=10)
ggcorrplot(cormat)
dev.off()
# change connectivity class 
    
```


```{r}
require(tidyverse)
require(psych)

names(trends_prism_landcover)
#  [1] "lake_nhdid"                  "epanutr_zoneid"             
#  [3] "hu12_zoneid"                 "lake_elevation_m"           
#  [5] "lake_lat_decdeg"             "lake_lon_decdeg"            
#  [7] "lake_waterarea_ha"           "lake_perimeter_m"           
#  [9] "lake_islandperimeter_m"      "lake_connectivity_class"    
# [11] "lake_connectivity_permanent" "lake_totalperimeter_m"      
# [13] "ws_area_ha"                  "ws_lake_arearatio"          
# [15] "range_dwl_site"              "mean_range_dwl_site"        
# [17] "lm_yint"                     "lm_pval"                    
# [19] "lm_rsq"                      "lm_slope"                   
# [21] "resid_yint"                  "resid_pval"                 
# [23] "resid_rsq"                   "resid_slope"                
# [25] "dwl_prior2002"               "trend_cat"                  
# [27] "avg_obs_site"                "avg_obs_days_site"          
# [29] "avg_dwl_site"                "avg_range_dwl_site"         
# [31] "avg_temp_degC"               "range_temp_degC"            
# [33] "avg_ppt"                     "obs_year_prism"             
# [35] "landcover_first_year"        "landcover_last_year"        
# [37] "obs_year_landcover"          "avg_nlcd_barren31_pct"      
# [39] "avg_nlcd_cultcrop82_pct"     "avg_nlcd_devhi24_pct"       
# [41] "avg_nlcd_devlow22_pct"       "avg_nlcd_devmed23_pct"      
# [43] "avg_nlcd_devopen21_pct"      "avg_nlcd_forcon42_pct"      
# [45] "avg_nlcd_fordec41_pct"       "avg_nlcd_formix43_pct"      
# [47] "avg_nlcd_grass71_pct"        "avg_nlcd_icesnow12_pct"     
# [49] "avg_nlcd_openwater11_pct"    "avg_nlcd_past81_pct"        
# [51] "avg_nlcd_shrub52_pct"        "avg_nlcd_wetemerg95_pct"    
# [53] "avg_nlcd_wetwood90_pct" 


# select the variables you want to work on, but it will automatically grab date and lake_ndhid
Y <- trends_prism_landcover %>%
        select(
                lake_nhdid,
                lake_elevation_m,
                lake_lat_decdeg,
                lake_lon_decdeg,
                lake_waterarea_ha,
                lake_perimeter_m,
                lake_islandperimeter_m,
                ws_area_ha,
                avg_temp_degC,
                range_temp_degC,
                avg_ppt,
                avg_nlcd_barren31_pct,
                avg_nlcd_cultcrop82_pct,
                avg_nlcd_devhi24_pct,
                avg_nlcd_devlow22_pct,
                avg_nlcd_devmed23_pct,
                avg_nlcd_devopen21_pct,
                avg_nlcd_forcon42_pct,
                avg_nlcd_fordec41_pct,
                avg_nlcd_formix43_pct,
                avg_nlcd_grass71_pct,
                avg_nlcd_icesnow12_pct,
                avg_nlcd_openwater11_pct,
                avg_nlcd_past81_pct,
                avg_nlcd_shrub52_pct,
                avg_nlcd_wetemerg95_pct,
                avg_nlcd_wetwood90_pct
        )

dim(Y)
#[1] 81035    27
Y <- Y %>%
       column_to_rownames(var = "lake_nhdid") %>% distinct() %>% drop_na()
dim(Y)
#[1] 80959    26

S <- cov(Y)
R <- cor(Y)
round(R,4)

pc <- princomp(Y, cor=T)
spc <- summary(pc, loadings=T, cutoff=0)
lambda <- pc$sd^2

#subset only by lakes in Y
trends_prism_landcover_sub <- trends_prism_landcover %>%
        filter(lake_nhdid %in% rownames(Y))
nrow(trends_prism_landcover_sub)==nrow(Y) #true
 
rm(list=setdiff(ls(), c("pc","spc","Y","trends_prism_landcover_sub")))

save.image(paste0("../data_analysis/",Sys.Date(),"_PCA_Fig1.Rdata"))

#if you wanted to visually look at
png(paste0("../data_analysis/",Sys.Date(),"_correlation_vars_PCA.png"), height=10, width=10, units="in",res=400)
pairs.panels(Y,
             lm=T,
             method="pearson",
             density=T,
             hist.col = "green4",
             ellipses=F,
             ci=F)
dev.off()

```

Put onto local drive

```{r}
load("/Users/jordanscheibe/Library/CloudStorage/OneDrive-UniversityofWyoming/Collaborations/LakeColor/2024-02-14_PCA_Fig1.rdata")
```


Look at the summary and decide how many PCAs you want to keep based on
1. The proportion of variance (try to get up to 80%)
2. Eigenvalues in "Importance of components" - Standard deviation should be greater than 1
3. Where is "the elbow in the plot"
```{r}
spc

for (i in 1:9){
print(paste0("Principal component",i))
print(pc$loadings[which(abs(pc$loadings[,i])>0.3),i])
}

plot(pc, type="lines", main = "")
```

Decision - I'm going to keep 9 PCs...

Interpret loadings using a cutoff of 0.3
Component 1 - could represent higher elevation lakes have lower longitudes (in the east) and have lower development landcover
Component 2 - development measures are correlated
Component 3 - smaller lake areas have smaller lake perimeters (duh), with smaller island perimeters, and smaller watershed areas
Component 4 - lower latitude lakes have more rain, higher mixed forest, and lower shrubs
Component 5 - higher latitudes have lower temperatures, more grasslands and less pastures
Component 6 - lower temperature ranges occur in more barren places with lower deciduous forest cover and higher wetland woods
Component 7 - lower temperature ranges are in higher cultivated crop areas and pastures with shrubs and less wetemerge
Component 8 - higher cultivated crops is highest conifer and deciduous forests and lower forest mixed and less shrubs
Component 9 - lower cultivated crops has lower open water and more pastures and wet woodlands





Plot
```{r}
bg.fui = tibble(
        ymin = c(470,475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583),
        ymax = c(475,480,485,489,495,509,530,549,559,564,567,568,569,570,573,575,577,579,581,583,590),
        color = paste0(c(
                "#2158bc", "#316dc5", "#327cbb", "#4b80a0", "#568f96", "#6d9298", "#698c86", 
                "#759e72", "#7ba654", "#7dae38", "#94b660","#94b660", "#a5bc76", "#aab86d", 
                "#adb55f", "#a8a965", "#ae9f5c", "#b3a053", "#af8a44", "#a46905", "#9f4d04"),"60")
)

bg.fui<-as.data.frame(bg.fui)



pc.scores <- as.data.frame(pc$scores)
pc.scores<-pc.scores %>% 
        rownames_to_column() %>%
        rename(lake_nhdid=rowname) %>%
        inner_join(.,trends_prism_landcover_sub, by=join_by(lake_nhdid)) %>%
        mutate( col_hex = case_when(avg_dwl_site >=bg.fui[1,1] & avg_dwl_site <bg.fui[1,2] ~ bg.fui[1,3],
                                    avg_dwl_site >=bg.fui[2,1] & avg_dwl_site <bg.fui[2,2] ~bg.fui[2,3], 
                                    avg_dwl_site >=bg.fui[3,1] & avg_dwl_site <bg.fui[3,2] ~bg.fui[3,3]   , 
                                    avg_dwl_site >=bg.fui[4,1] & avg_dwl_site <bg.fui[4,2] ~bg.fui[4,3]   , 
                                    avg_dwl_site >=bg.fui[5,1] & avg_dwl_site <bg.fui[5,2] ~bg.fui[5,3]   , 
                                    avg_dwl_site >=bg.fui[6,1] & avg_dwl_site <bg.fui[6,2] ~bg.fui[6,3]   , 
                                    avg_dwl_site >=bg.fui[7,1] & avg_dwl_site <bg.fui[7,2] ~bg.fui[7,3]   , 
                                    avg_dwl_site >=bg.fui[8,1] & avg_dwl_site <bg.fui[8,2] ~bg.fui[8,3]   , 
                                    avg_dwl_site >=bg.fui[9,1] & avg_dwl_site <bg.fui[9,2] ~bg.fui[9,3]   , 
                                    avg_dwl_site >=bg.fui[10,1] & avg_dwl_site <bg.fui[10,2] ~bg.fui[10,3]   , 
                                    avg_dwl_site >=bg.fui[11,1] & avg_dwl_site <bg.fui[11,2] ~bg.fui[11,3]   , 
                                    avg_dwl_site >=bg.fui[12,1] & avg_dwl_site <bg.fui[12,2] ~bg.fui[12,3]   , 
                                    avg_dwl_site >=bg.fui[13,1] & avg_dwl_site <bg.fui[13,2] ~bg.fui[13,3]   , 
                                    avg_dwl_site >=bg.fui[14,1] & avg_dwl_site <bg.fui[14,2] ~bg.fui[14,3]   , 
                                    avg_dwl_site >=bg.fui[15,1] & avg_dwl_site <bg.fui[15,2] ~bg.fui[15,3]   , 
                                    avg_dwl_site >=bg.fui[16,1] & avg_dwl_site <bg.fui[16,2] ~bg.fui[16,3]   , 
                                    avg_dwl_site >=bg.fui[17,1] & avg_dwl_site <bg.fui[17,2] ~bg.fui[17,3]   , 
                                    avg_dwl_site >=bg.fui[18,1] & avg_dwl_site <bg.fui[18,2] ~bg.fui[18,3]   , 
                                    avg_dwl_site >=bg.fui[19,1] & avg_dwl_site <bg.fui[19,2] ~bg.fui[19,3]   , 
                                    avg_dwl_site >=bg.fui[20,1] & avg_dwl_site <bg.fui[20,2] ~bg.fui[20,3]   , 
                                    avg_dwl_site >=bg.fui[21,1] & avg_dwl_site <=bg.fui[21,2] ~bg.fui[21,3] , T~"black"))


# rename variable labels

rownames(pc$loadings)<- c("Elevation (m)" , "Latitude" , "Longitutde",
"Lake area (ha)" , "Lake perimeter (m)" , "Island perimeter (m)",
"W.S. area (ha)" , "Temp (C)" , "Range temp (C)",
"Precip (ppt)" , "Barren (%)" , "Cultcrop (%)",
"Devhi (%)" , "Devlow (%)" , "Devmed (%)",
"Devopen (%)" , "Forcon (%)" , "Fordec (%)",
"Formix (%)" , "Grass (%)" , "Icesnow (%)",
"Openwater (%)" , "Past (%)" , "Shrub (%)",
"Wetemerg (%)" , "Wetwood (%)")





i=1
for(i in 1:8){
load <- pc$loadings[, c(i,i+1)]
load <- load[abs(load[,1])>0.3 | abs(load[,2])>0.3, ]

png(paste0("../",Sys.Date(),"_PC",i,"_PC",i+1,"_SepScale.png"), width = 8, height=6, units = "in", res=400)
par(mar=c(5,5,1,1), xpd=T)
plot(pc.scores[,i+1], pc.scores[,i+2], pch = 19, col = pc.scores$col_hex, xlab=paste0("PC",i),ylab=paste0("PC",i+1))

# scaling factor for arrow length
scaling_factor <- c(19,30,15,10,12,12,12,15)[i]


# Add arrows for loadings of PC1 and PC2
arrows(0, 0, load[, 1] * scaling_factor, load[, 2] * scaling_factor, 
       angle = 20, length = 0.1, col = "black")


text(load[, 1] * scaling_factor, load[, 2] * scaling_factor,
     labels = rownames(load), pos = 3, col = "black", cex = 1.1)
dev.off()
}

```


Multiple linear regression using our components
```{r}
lake_color <-
```



# 4. Figure 3 - time series

```{r}

```


# 4. seasonal variability in lake color

```{r}
names(temporal)
require(ggplot2)
# Get state borders
states <- map_data("state")

temporal_uniq<-temporal %>%
        select(lake_nhdid, lake_lat_decdeg, lake_lon_decdeg, mean_range_dwl_site, lake_waterarea_ha) %>%
        distinct()

map_trends<-ggplot(data = temporal_uniq, aes(x = lake_lon_decdeg, y = lake_lat_decdeg)) +
  geom_point(size = 0.7) +
  scale_color_continuous(values = levels(temporal_uniq$trend_color), 
                     labels = levels(temporal_uniq$trend_cat)) + 
        guides(color = guide_legend(override.aes = list(size = 5))) +
  theme_void() +
  coord_fixed(1.3) +
labs(color = "Lake color trend") +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "transparent", color = "black", linewidth = 0.5) +
        theme(legend.position = "right",  # Change the legend position to the right
        legend.box.margin = margin(l = -20))


jpeg(paste0("Figures/",Sys.Date(),"_LakeColorTrends_EcoRegionsMap.jpg"),height=6,width=9, res=500, units="in")
map_trends
dev.off()

```













# Figuring out why no TX and GA

```{r}
require(tidyverse)
require(ggplot2)
lake_data<-readRDS("2023-09-29_lagos_landcover_data.rds") #this is the lake data and landcover - need to remove land cover 

# merge with Lagos data (should be static for each lake)
# first take out the landcover data that was attached
lagos<-lake_data[,1:15]
lagos<-distinct(lagos)
nrow(lagos)
#479950

write.csv(lagos,"LAGOSONLYDATA_TEST.csv")


lagos<-read.csv("../LAGOSONLYDATA_TEST.csv")


require(ggplot2)

# Get state borders
states <- map_data("state")

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6"
)

lagos$ecoregion_color <- cols[as.factor(lagos$epanutr_zoneid )]

wmap<-ggplot(data = lagos) + 
        geom_point(data = lagos, aes(x = lake_lon_decdeg, y = lake_lat_decdeg), color = lagos$ecoregion_color, size = 1) +  # Add points
        scale_fill_distiller( palette="Spectral", direction=1)+
        theme_void()+
       coord_fixed(1.3) +
        geom_polygon(data= states, aes(x = long, y = lat, group = group), fill="transparent",color = "black", size=0.5)
wmap





require(tidyverse)
require(ggplot2)
load("2023-10-19_SPATIAL_Limnosat_May_Oct_Lagos_Landcover.RData")

spatial<-spatial[,names(spatial)%in% c("epanutr_zoneid","lake_lon_decdeg","lake_lat_decdeg")]
spatial<-distinct(spatial)

# Get state borders
states <- map_data("state")

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
   "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "black","deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6"
)

spatial$ecoregion_color <- cols[as.factor(spatial$epanutr_zoneid )]

wmap<-ggplot(data = spatial) + 
        geom_point(data = spatial, aes(x = lake_lon_decdeg, y = lake_lat_decdeg), color = spatial$ecoregion_color, size = 1) +  # Add points
        scale_fill_distiller( palette="Spectral", direction=1)+
        theme_void()+
       coord_fixed(1.3) +
        geom_polygon(data= states, aes(x = long, y = lat, group = group), fill="transparent",color = "black", size=0.5)

pdf(paste0(Sys.Date(),"_SPAITAL_sitesByEcoregion.pdf"),height=4, width=6)
           wmap
           dev.off()
           

           
           
           
#look at the initial dataframe used to make             
load("archive/2023-10-18_Limnosat_May_Oct_Lagos.RData")
objects()
spatial<-limnosat_may_oct_lagos
spatial<-spatial[,names(spatial)%in% c("epanutr_zoneid","lake_lon_decdeg","lake_lat_decdeg")]
spatial<-distinct(spatial)

# Get state borders
states <- map_data("state")

cols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
   "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#FDBF6F", # lt orange
  "maroon", "orchid1", "black","deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown","gray","khaki2","#CAB2D6"
)

spatial$ecoregion_color <- cols[as.factor(spatial$epanutr_zoneid )]

wmap<-ggplot(data = spatial) + 
        geom_point(data = spatial, aes(x = lake_lon_decdeg, y = lake_lat_decdeg), color = spatial$ecoregion_color, size = 1) +  # Add points
        scale_fill_distiller( palette="Spectral", direction=1)+
        theme_void()+
       coord_fixed(1.3) +
        geom_polygon(data= states, aes(x = long, y = lat, group = group), fill="transparent",color = "black", size=0.5)

pdf(paste0(Sys.Date(),"_Limnosat_May_Oct_Lagos_sitesByEcoregion.pdf"),height=4, width=6)
           wmap
           dev.off()
```



checking if GA has permanent column values (ndhids)
```{r}
all_GA <- c("GA_16038.csv", "GA_16039.csv", "GA_17037.csv" ,"GA_17038.csv", "GA_17039.csv" ,"GA_18036.csv" ,"GA_18037.csv", "GA_18038.csv" ,"GA_18039.csv","GA_19036.csv", "GA_19037.csv" ,"GA_19038.csv", "GA_19039.csv" ,"GA_20036.csv", "GA_20037.csv")

uniq_GA<-vector()
i=1
for(i in 1:length(all_GA)){
GA<-read.csv(all_GA[1], header=T)
uniq_GA<-c(uniq_GA,unique(GA$permanent))
}
uniq_GA
 #[1] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA
```






Question - what types of lakes were removed with the temporal dataset?

